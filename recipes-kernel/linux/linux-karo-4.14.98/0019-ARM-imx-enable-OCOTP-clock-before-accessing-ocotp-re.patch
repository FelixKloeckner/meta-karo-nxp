From f7f60c96330268c8859c36a2617de623f157f5f0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lothar=20Wa=C3=9Fmann?= <LW@KARO-electronics.de>
Date: Wed, 10 Jul 2019 17:24:28 +0200
Subject: [PATCH 1/2] ARM: imx: enable OCOTP clock before accessing ocotp
 registers
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Lothar Wa√ümann <LW@KARO-electronics.de>
---
 arch/arm/mach-imx/mach-imx6ul.c | 24 +++++++++++++++++++++---
 1 file changed, 21 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-imx/mach-imx6ul.c b/arch/arm/mach-imx/mach-imx6ul.c
index 99eb8ad811cb..6fdd7266a10e 100644
--- a/arch/arm/mach-imx/mach-imx6ul.c
+++ b/arch/arm/mach-imx/mach-imx6ul.c
@@ -5,6 +5,7 @@
  * it under the terms of the GNU General Public License version 2 as
  * published by the Free Software Foundation.
  */
+#include <linux/clk.h>
 #include <linux/irqchip.h>
 #include <linux/mfd/syscon.h>
 #include <linux/mfd/syscon/imx6q-iomuxc-gpr.h>
@@ -31,7 +32,6 @@ static void __init imx6ul_enet_clk_init(void)
 				   IMX6UL_GPR1_ENET_CLK_OUTPUT);
 	else
 		pr_err("failed to find fsl,imx6ul-iomux-gpr regmap\n");
-
 }

 static int ksz8081_phy_fixup(struct phy_device *dev)
@@ -79,6 +79,8 @@ static void __init imx6ul_opp_check_speed_grading(struct device *cpu_dev)
 	struct device_node *np;
 	void __iomem *base;
 	u32 val;
+	struct clk *ocotp_clk;
+	int ret;

 	if (cpu_is_imx6ul())
 		np = of_find_compatible_node(NULL, NULL, "fsl,imx6ul-ocotp");
@@ -90,10 +92,22 @@ static void __init imx6ul_opp_check_speed_grading(struct device *cpu_dev)
 		return;
 	}

+	ocotp_clk = of_clk_get(np, 0);
+	if (IS_ERR(ocotp_clk)) {
+		ret = PTR_ERR(ocotp_clk);
+		dev_err(cpu_dev, "failed to get ocotp clock: %d\n", ret);
+		goto put_node;
+	}
+	ret = clk_prepare_enable(ocotp_clk);
+	if (ret) {
+		dev_err(cpu_dev, "failed to enable ocotp clock: %d\n", ret);
+		goto put_clk;
+	}
+
 	base = of_iomap(np, 0);
 	if (!base) {
 		pr_warn("failed to map ocotp\n");
-		goto put_node;
+		goto disable_clk;
 	}

 	/*
@@ -121,12 +135,16 @@ static void __init imx6ul_opp_check_speed_grading(struct device *cpu_dev)
 		}

 		if (val != OCOTP_CFG3_SPEED_900MHZ) {
-			if(dev_pm_opp_disable(cpu_dev, 900000000))
+			if (dev_pm_opp_disable(cpu_dev, 900000000))
 				pr_warn("Failed to disable 900MHz OPP\n");
 		}
 	}
 	iounmap(base);

+disable_clk:
+	clk_disable_unprepare(ocotp_clk);
+put_clk:
+	clk_put(ocotp_clk);
 put_node:
 	of_node_put(np);
 }
--
2.11.0
