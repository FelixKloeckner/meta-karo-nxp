From 5ed7d5a5906a6ee8754cd9681dc8903a22467e9c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lothar=20Wa=C3=9Fmann?= <LW@KARO-electronics.de>
Date: Tue, 3 Dec 2019 10:51:02 +0100
Subject: [PATCH 1/4] arm: imx6: fix compile error when CONFIG_ARM_PSCI_FW is
 not enabled

---
 arch/arm/mach-imx/cpuidle-imx6ul.c |  8 ++++----
 arch/arm/mach-imx/pm-imx6.c        | 12 ++++--------
 2 files changed, 8 insertions(+), 12 deletions(-)

diff --git a/arch/arm/mach-imx/cpuidle-imx6ul.c b/arch/arm/mach-imx/cpuidle-imx6ul.c
index 4f22b8f..6bff2b5 100644
--- a/arch/arm/mach-imx/cpuidle-imx6ul.c
+++ b/arch/arm/mach-imx/cpuidle-imx6ul.c
@@ -93,12 +93,12 @@ static void (*imx6ul_wfi_in_iram_fn)(void __iomem *iram_vbase);
 
 static int imx6ul_idle_finish(unsigned long val)
 {
+#ifdef CONFIG_ARM_PSCI_FW
 	if (psci_ops.cpu_suspend)
-		psci_ops.cpu_suspend(MX6UL_POWERDWN_IDLE_PARAM,
+		return psci_ops.cpu_suspend(MX6UL_POWERDWN_IDLE_PARAM,
 				     __pa(cpu_resume));
-	else
-		imx6ul_wfi_in_iram_fn(wfi_iram_base);
-
+#endif
+	imx6ul_wfi_in_iram_fn(wfi_iram_base);
 	return 0;
 }
 
diff --git a/arch/arm/mach-imx/pm-imx6.c b/arch/arm/mach-imx/pm-imx6.c
index 5d0a7c3..5fade56 100644
--- a/arch/arm/mach-imx/pm-imx6.c
+++ b/arch/arm/mach-imx/pm-imx6.c
@@ -757,11 +757,12 @@ int imx6_set_lpm(enum mxc_cpu_pwr_mode mode)
 
 static int imx6q_suspend_finish(unsigned long val)
 {
+#ifdef CONFIG_ARM_PSCI_FW
 	if (psci_ops.cpu_suspend) {
 		return psci_ops.cpu_suspend(MX6Q_SUSPEND_PARAM,
 					    __pa(cpu_resume));
 	}
-
+#endif
 	if (!imx6_suspend_in_ocram_fn) {
 		cpu_do_idle();
 	} else {
@@ -1072,7 +1073,6 @@ void __init imx6_pm_map_io(void)
 
 static int __init imx6q_suspend_init(const struct imx6_pm_socdata *socdata)
 {
-	struct device_node *node;
 	struct imx6_cpu_pm_info *pm_info;
 	unsigned long iram_paddr;
 	int i, ret = 0;
@@ -1086,12 +1086,13 @@ static int __init imx6q_suspend_init(const struct imx6_pm_socdata *socdata)
 		return -EINVAL;
 	}
 
+#ifdef CONFIG_ARM_PSCI_FW
 	if (psci_ops.cpu_suspend) {
 		/* TODO: seems not needed */
 		/* of_node_put(node); */
 		return ret;
 	}
-
+#endif
 	/*
 	 * 16KB is allocated for IRAM TLB, but only up 8k is for kernel TLB,
 	 * The lower 8K is not used, so use the lower 8K for IRAM code and
@@ -1236,11 +1237,6 @@ static int __init imx6q_suspend_init(const struct imx6_pm_socdata *socdata)
 		&imx6_suspend,
 		MX6Q_SUSPEND_OCRAM_SIZE - sizeof(*pm_info));
 
-	goto put_node;
-
-put_node:
-	of_node_put(node);
-
 	return ret;
 }
 
-- 
2.7.4

